<script>
document.addEventListener("DOMContentLoaded", function() {
  const descriptionContainer = document.getElementById('book-description');
  const loader = document.getElementById('loader');
  const bookSlug = "{{ page.book_slug }}";
  
  if (bookSlug) {
    // 1. Формируем прямой адрес к Тильде
    const targetUrl = `https://pro-culinaria.ru/tpost/${bookSlug}`;
    
    // 2. Оборачиваем в прокси, чтобы браузер не блокировал запрос
    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(targetUrl);

    fetch(proxyUrl)
      .then(response => {
        if (response.ok) return response.json();
        throw new Error('Network error');
      })
      .then(data => {
        const parser = new DOMParser();
        // data.contents — это само тело страницы, которое вернул прокси
        const doc = parser.parseFromString(data.contents, 'text/html');
        
        // 3. Ищем блок с контентом на Тильде
        const content = doc.querySelector('.t-records');
        
        if (content) {
          loader.style.display = 'none';
          descriptionContainer.innerHTML = content.innerHTML;
          
          // Удаляем лишние кнопки Тильды, если они просочились
          const extra = descriptionContainer.querySelectorAll('.t-btn, .t-form');
          extra.forEach(el => el.remove());
        } else {
          loader.innerText = 'Описание временно недоступно.';
        }
      })
      .catch(err => {
        console.error(err);
        loader.innerText = 'Ошибка при подключении к базе данных.';
      });
  }
});
</script>
