<script>
document.addEventListener("DOMContentLoaded", function() {
  const descriptionContainer = document.getElementById('book-description');
  const loader = document.getElementById('loader');
  
  // Берем slug из параметров страницы (например, "les-cookeis-de-nos-reve")
  const bookSlug = "{{ page.book_slug }}";
  
  if (bookSlug) {
    // Формируем финальный URL на Тильду
    const targetUrl = `https://pro-culinaria.ru/tpost/${bookSlug}`;

    // Используем прокси для обхода CORS
    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(targetUrl);

    fetch(proxyUrl)
      .then(response => {
        if (response.ok) return response.json();
        throw new Error('Ошибка сети');
      })
      .then(data => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, 'text/html');
        
        // На Тильде в tpost контент обычно лежит в блоках t603 или t-records
        // Мы ищем самый наполненный текстовый блок
        const content = doc.querySelector('.t603__wrapper') || doc.querySelector('.t-records');
        
        if (content) {
          loader.style.display = 'none';
          
          // Вставляем контент
          descriptionContainer.innerHTML = content.innerHTML;
          
          // Чистим от мусора: удаляем лишние скрипты Тильды и кнопки "Купить", если они есть
          const scripts = descriptionContainer.querySelectorAll('script, style, .t-btn, .t-form');
          scripts.forEach(el => el.remove());
        } else {
          loader.innerText = 'Описание подгружается...';
        }
      })
      .catch(err => {
        console.error(err);
        loader.innerText = 'Не удалось загрузить описание. Вы можете прочитать его на основном сайте.';
      });
  }
});
</script>
