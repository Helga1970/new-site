---
layout: default
---

<div class="book-page-wrapper" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px; display: flex; gap: 30px; font-family: sans-serif;">
  
  <div class="book-main-content" style="width: 70%; min-width: 0;">
    <img src="{{ page.book_cover }}" alt="{{ page.book_title }}" 
         style="float: left; width: 280px; margin: 0 25px 20px 0; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">

    <h1 style="margin: 0 0 10px 0; font-size: 2.2rem; color: #333;">{{ page.book_title }}</h1>
    <p style="color: #888; font-style: italic; margin-bottom: 25px;">{{ page.book_author }}</p>
      
    <div class="book-description" style="line-height: 1.6; color: #444; font-size: 1.1rem; text-align: justify;">
      {{ content }}
    </div>

    <div style="margin-top: 30px; clear: both;">
      <a href="{{ page.book_link }}" target="_blank" 
         style="display: inline-block; background: #fa8569; color: #fff; text-decoration: none; padding: 15px 35px; border-radius: 5px; font-weight: bold; text-transform: uppercase;">
        Открыть книгу
      </a>
    </div>
  </div>

  <div class="book-sidebar" style="width: 30%; border-left: 1px solid #eee; padding-left: 20px;">
    <div class="sidebar-header" style="border-bottom: 2px solid #fa8569; padding-bottom: 15px; margin-bottom: 20px;">
      <h3 style="margin: 0 0 10px 0; font-size: 1.1rem; color: #333;">Рецепты (<span id="recipes-count">0</span>)</h3>
      
      <div class="filter-container">
        <button class="filter-toggle" id="filter-toggle" style="width: 100%; padding: 6px; font-size: 0.75rem; display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
          <span class="button-text">Фильтр</span>
          <span class="selected-count" style="color: #fa8569; font-weight: bold;"></span>
        </button>
        <div class="checkbox-list-container hidden" id="checkbox-list-container">
          <div class="checkbox-item all-option">
            <input type="checkbox" id="all-categories" value="all">
            <label for="all-categories">Все категории</label>
          </div>
        </div>
      </div>
    </div>
    
    <div id="mini-recipes-grid" class="mini-recipe-grid"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async function () {
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const bookSlug = pathParts[pathParts.length - 1];
    const jsonUrl = `/api/recipes/${bookSlug}.json`;

    const grid = document.getElementById("mini-recipes-grid");
    const filterToggle = document.getElementById("filter-toggle");
    const checkboxContainer = document.getElementById("checkbox-list-container");
    const selectedCountSpan = document.querySelector('.selected-count');
    const allCategoriesCheckbox = document.getElementById('all-categories');
    let allRecipes = [];
    let categoryCounts = {};

    const renderRecipes = (recipesToRender) => {
        grid.innerHTML = "";
        recipesToRender.forEach(recipe => {
            const imageUrl = recipe.featured_image || recipe.book_cover;
            const card = document.createElement("div");
            card.className = "mini-recipe-card";
            card.innerHTML = `
                <a href="${recipe.url}">
                    <div class="mini-image-wrapper"><img src="${imageUrl}" alt="${recipe.title}"></div>
                    <div class="mini-title-box"><h2 class="mini-title">${recipe.title}</h2></div>
                </a>`;
            grid.appendChild(card);
        });
    };

    try {
        const response = await fetch(jsonUrl);
        allRecipes = await response.json();
        document.getElementById("recipes-count").textContent = allRecipes.length;

        const categories = [...new Set(allRecipes.flatMap(r => r.categories || []))].sort();
        categoryCounts = allRecipes.reduce((counts, recipe) => {
            (recipe.categories || []).forEach(cat => counts[cat] = (counts[cat] || 0) + 1);
            return counts;
        }, {});
        
        categories.forEach(category => {
            const checkboxId = `cat-${category.replace(/\s+/g, '-').toLowerCase()}`;
            const itemDiv = document.createElement("div");
            itemDiv.className = "checkbox-item";
            itemDiv.innerHTML = `<input type="checkbox" id="${checkboxId}" value="${category}"><label for="${checkboxId}">${category}</label>`;
            checkboxContainer.appendChild(itemDiv);
        });

        renderRecipes(allRecipes);
        filterToggle.addEventListener("click", () => checkboxContainer.classList.toggle("hidden"));
        
        checkboxContainer.addEventListener("change", (e) => {
            if (e.target.id === 'all-categories') {
                checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb !== allCategoriesCheckbox) {
                        cb.checked = false;
                        cb.nextElementSibling.textContent = cb.value;
                    }
                });
            } else {
                allCategoriesCheckbox.checked = false;
                e.target.nextElementSibling.textContent = e.target.checked ? `${e.target.value} (${categoryCounts[e.target.value] || 0})` : e.target.value;
            }

            const checkedBoxes = Array.from(checkboxContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const filtered = (checkedBoxes.length === 0 || checkedBoxes.includes('all')) 
                ? allRecipes 
                : allRecipes.filter(r => (r.categories || []).some(cat => checkedBoxes.includes(cat)));
            renderRecipes(filtered);
            const count = checkedBoxes.filter(v => v !== 'all').length;
            selectedCountSpan.textContent = count > 0 ? `(${count})` : '';
        });
    } catch (e) { grid.innerHTML = "<p>...</p>"; }
});
</script>

<style>
.mini-recipe-grid { 
  display: grid; 
  grid-template-columns: 1fr 1fr; /* Фиксируем две колонки */
  gap: 10px; 
}
.mini-recipe-card { background: #fff; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.mini-image-wrapper { width: 100%; aspect-ratio: 1/1; position: relative; }
.mini-image-wrapper img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; }
.mini-title-box { padding: 5px; text-align: center; min-height: 35px; display: flex; align-items: center; justify-content: center; }
.mini-title { font-size: 0.7rem; margin: 0; color: #333; line-height: 1.1; font-weight: 600; }

.filter-container { position: relative; width: 100%; }
.checkbox-list-container { 
    position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; 
    z-index: 100; padding: 8px; max-height: 200px; overflow-y: auto; box-shadow: 0 5px 10px rgba(0,0,0,0.1);
}
.hidden { display: none; }
.checkbox-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 0.7rem; }
.checkbox-item input { margin-right: 5px; }

@media (max-width: 900px) {
  .book-page-wrapper { flex-direction: column; }
  .book-main-content, .book-sidebar { width: 100%; padding: 0; border: none; }
}
</style>
