---
layout: default
---

<style>
    /* ПРИНУДИТЕЛЬНОЕ РАСШИРЕНИЕ И ЦЕНТРОВКА */
    .container.main-content, .container, .content {
        max-width: 1400px !important;
        width: 95% !important;
        margin: 0 auto !important; /* Центрируем всё */
    }

    .book-page-wrapper {
        max-width: 1400px !important;
        display: flex !important;
        justify-content: center; /* Центрируем колонки между собой */
        gap: 50px;
        margin: 20px auto 0 auto;
    }

    /* Левая колонка — 70-75% */
    .book-main-content {
        width: 70% !important;
        flex: none !important;
        min-width: 0;
    }

    /* Правая колонка — фиксируем для 2-х карточек */
    .book-sidebar {
        width: 350px !important;
        flex-shrink: 0 !important;
        border-left: 1px solid #eee;
        padding-left: 25px;
    }

    /* Картинка с обтеканием */
    .book-main-content img.book-cover {
        float: left !important;
        width: 300px !important;
        margin: 0 30px 20px 0 !important;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    /* Сетка рецептов: строго 2 в ряд */
    .mini-recipe-grid { 
        display: grid !important; 
        grid-template-columns: 1fr 1fr !important; 
        gap: 15px; 
    }

    .mini-recipe-card { background: #fff; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: 0.3s; }
    .mini-recipe-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
    .mini-image-wrapper { width: 100%; aspect-ratio: 1/1; position: relative; overflow: hidden; }
    .mini-image-wrapper img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; }
    .mini-title-box { padding: 8px 4px; text-align: center; min-height: 45px; display: flex; align-items: center; justify-content: center; }
    .mini-title { font-size: 0.75rem !important; margin: 0; color: #333; line-height: 1.2; font-weight: 600; }

    .filter-container { position: relative; width: 100%; margin-top: 10px; }
    .checkbox-list-container { 
        position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; 
        z-index: 100; padding: 10px; max-height: 250px; overflow-y: auto; box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }
    
    @media (max-width: 1000px) {
        .book-page-wrapper { flex-direction: column; align-items: center; }
        .book-sidebar { width: 100% !important; border: none; padding-left: 0; }
        .book-main-content { width: 100% !important; }
    }
</style>

<div class="book-page-wrapper">
  
  <div class="book-main-content">
    <img src="{{ page.book_cover }}" alt="{{ page.book_title }}" class="book-cover">

    <h1 style="margin: 0 0 5px 0; font-size: 2.2rem; color: #333;">{{ page.book_title }}</h1>
    <p style="color: #888; font-style: italic; margin-bottom: 20px;">{{ page.book_author }}</p>
      
    <div class="book-description" style="line-height: 1.6; color: #444; font-size: 1.1rem; text-align: justify;">
      {{ content }}
    </div>

    <div style="margin-top: 30px; clear: both;">
      <a href="{{ page.book_link }}" target="_blank" 
         style="display: inline-block; background: #fa8569; color: #fff; text-decoration: none; padding: 12px 35px; border-radius: 5px; font-weight: bold; text-transform: uppercase;">
        Открыть книгу
      </a>
    </div>
  </div>

  <div class="book-sidebar">
    <div class="sidebar-header" style="border-bottom: 2px solid #fa8569; padding-bottom: 15px; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 1.1rem; color: #333; line-height: 1.4;">
        Все рецепты из книги (<span id="recipes-count">0</span>)
      </h3>
      
      <div class="filter-container">
        <button class="filter-toggle" id="filter-toggle" style="width: 100%; padding: 8px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
          <span>Фильтр категорий</span>
          <span class="selected-count" style="color: #fa8569; font-weight: bold;"></span>
        </button>
        <div class="checkbox-list-container hidden" id="checkbox-list-container">
          <div class="checkbox-item" style="padding-bottom: 5px; border-bottom: 1px solid #eee; margin-bottom: 5px;">
            <input type="checkbox" id="all-categories" value="all">
            <label for="all-categories" style="font-weight: bold; font-size: 0.8rem; margin-left: 5px;">Все</label>
          </div>
        </div>
      </div>
    </div>
    <div id="mini-recipes-grid" class="mini-recipe-grid"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async function () {
    const bookSlug = "{{ page.book_slug }}"; 
    const jsonUrl = `/api/recipes/${bookSlug}.json`;

    const grid = document.getElementById("mini-recipes-grid");
    const filterToggle = document.getElementById("filter-toggle");
    const checkboxContainer = document.getElementById("checkbox-list-container");
    const selectedCountSpan = document.querySelector('.selected-count');
    const allCategoriesCheckbox = document.getElementById('all-categories');
    let allRecipes = [];

    const renderRecipes = (recipesToRender) => {
        grid.innerHTML = "";
        recipesToRender.forEach(recipe => {
            const imageUrl = recipe.featured_image || recipe.book_cover;
            grid.insertAdjacentHTML('beforeend', `
                <div class="mini-recipe-card">
                    <a href="${recipe.url}" style="text-decoration:none; color:inherit;">
                        <div class="mini-image-wrapper"><img src="${imageUrl}" alt="${recipe.title}"></div>
                        <div class="mini-title-box"><h2 class="mini-title">${recipe.title}</h2></div>
                    </a>
                </div>`);
        });
    };

    try {
        const response = await fetch(jsonUrl);
        allRecipes = await response.json();
        document.getElementById("recipes-count").textContent = allRecipes.length;

        const categories = [...new Set(allRecipes.flatMap(r => r.categories || []))].sort();
        categories.forEach(category => {
            const itemDiv = document.createElement("div");
            itemDiv.style.display = "flex";
            itemDiv.style.alignItems = "center";
            itemDiv.style.marginBottom = "5px";
            itemDiv.innerHTML = `<input type="checkbox" id="cat-${category}" value="${category}"><label for="cat-${category}" style="font-size: 0.8rem; margin-left: 5px; cursor:pointer;">${category}</label>`;
            checkboxContainer.appendChild(itemDiv);
        });

        renderRecipes(allRecipes);
        filterToggle.addEventListener("click", () => checkboxContainer.classList.toggle("hidden"));

        checkboxContainer.addEventListener("change", (e) => {
            if (e.target.id === 'all-categories' && e.target.checked) {
                checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { if(cb !== allCategoriesCheckbox) cb.checked = false; });
            } else if (e.target !== allCategoriesCheckbox) {
                allCategoriesCheckbox.checked = false;
            }

            const checkedBoxes = Array.from(checkboxContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const filtered = (checkedBoxes.length === 0 || checkedBoxes.includes('all')) 
                ? allRecipes 
                : allRecipes.filter(r => (r.categories || []).some(cat => checkedBoxes.includes(cat)));
            
            renderRecipes(filtered);
            selectedCountSpan.textContent = checkedBoxes.length > 0 && !checkedBoxes.includes('all') ? `(${checkedBoxes.length})` : '';
        });
    } catch (e) { console.error("Error loading recipes:", e); }
});
</script>
