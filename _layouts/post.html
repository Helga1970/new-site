---
layout: default
---
<article class="post">
	{% include post-heading.html post=page post_page=true %}

{% if page.book %}
  <div class="book-block mobile-only">
    <img class="book-cover" src="{{ page.book.cover }}" alt="{{ page.book.title }}">
    <div class="book-meta">
      <h3>{{ page.book.title }}</h3>
      <p>{{ page.book.author }}</p>
    </div>
  </div>
  <div class="book-more-recipes mobile-only" style="background-color:#fa8569; color:#fff; font-weight:bold; border-radius:0; justify-content:center; align-items:center; padding:10px 0; width:100%;">
    Ещё рецепты из книги
  </div>
{% endif %}
	
<div class="recipe-wrapper">
	<div class="recipe-body">
		{{ content }}
	</div>
	
	<div class="image">
		<img src="{{ page.featured_image }}" alt="{{ page.title }}">
	</div>
</div>

	<ul id="recipe" class="recipe-overview">
  {% if page.recipe.servings %}
    <li title="Servings">{% include recipe-icon.html icon="quantity" %}<span>{{ page.recipe.servings }}</span></li>
  {% endif %}

  {% if page.recipe.prep %}
    <li title="Prep Time">{% include recipe-icon.html icon="time" %}<span>{{ page.recipe.prep }}</span></li>
  {% endif %}

  {% if page.recipe.cook %}
    <li title="Cook Time">{% include recipe-icon.html icon="cook" %}<span>{{ page.recipe.cook }}</span></li>
  {% endif %}

  {% if page.recipe.difficulty %}
  <li title="Difficulty">
    {% include recipe-icon.html icon="difficulty" %}
    <span class="star">
      {{ page.recipe.difficulty | replace: "*", "★" }}
    </span>
  </li>
{% endif %}
</ul>

	<div class="recipe-contents">
	<div class="ingredients">
		<h3 class="recipe-heading">Ингредиенты:</h3>
		{{ page.recipe.ingredients_markdown | markdownify }}
	</div>

	<div class="directions">
		<h3 class="recipe-heading">Приготовление:</h3>
		{{ page.recipe.directions_markdown | markdownify }}
	</div>
</div>

{% comment %} Код для похожих рецептов {% endcomment %}
{% assign current_tags = page.tags %}
{% assign all_recipes = site.recipes %}
{% assign related_recipes = "" | split: "" %}

{% for recipe in all_recipes %}
  {% if recipe.url != page.url %}
    {% assign common_tags = recipe.tags | intersection: current_tags %}
    {% if common_tags.size > 0 %}
      {% assign related_recipes = related_recipes | push: recipe %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign unique_related_recipes = related_recipes | uniq %}

{% if unique_related_recipes.size > 0 %}
  <div class="related-recipes-section">
    <h3>Похожие рецепты ({{ unique_related_recipes.size }})</h3>
    <div id="related-list" class="related-recipes-grid">
      {% for recipe in unique_related_recipes %}
        <div class="recipe-card-list-item hidden">
          <a href="{{ recipe.url | relative_url }}">
            {% if recipe.featured_image %}
              <div class="recipe-card-image-wrapper" style="height: 120px !important; overflow: hidden !important;">
  <img class="recipe-card-image" src="{{ recipe.featured_image }}" alt="{{ recipe.title }}" style="object-fit: cover !important;">
</div>
            {% endif %}
            <div class="recipe-card-content-list-item">
              <p class="recipe-title">{{ recipe.title }}</p>
              {% if recipe.book.title %}
               <p class="recipe-book">
      <span style="font-style:italic; color:#888; margin-right:4px;">Из книги</span>
      <span style="font-style:normal; color:#000;">{{ recipe.book.title }}</span>
    </p>
              {% endif %}
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
    <button id="show-more" style="background-color:#fa8569; color:#fff; font-weight:bold; border-radius:0; padding:8px 16px; font-size:1em; margin-top:12px; display:inline-block; border:none; cursor:pointer;">
      Показать ещё
    </button>
  </div>
{% endif %}
{% comment %} Конец кода для похожих рецептов {% endcomment %}

	{% if site.disqus_shortname and page.comments %}
		<div id="disqus_thread"></div>
		<script>
			var disqus_shortname = '{{ site.disqus_shortname }}';
			var disqus_config = function () {
				this.page.url = "{{ page.url | prepend: site.url }}";
				this.page.identifier = "{{ page.id }}";
			};
			(function() {
				var d = document, s = d.createElement('script');
				s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				s.setAttribute('data-timestamp', +new Date());
				(d.head || d.body).appendChild(s);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	{% endif %}
</article>
<style>
.related-recipes-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 15px;
}

.recipe-card-list-item {
  flex-basis: calc(50% - 10px);
  margin-bottom: 20px;
  background-color: #fafafa;
  display: flex;
  align-items: flex-start;
  overflow: hidden;
  height: 100px;
  border-radius: 0;
}

.recipe-card-image-wrapper {
  flex-shrink: 0;
  width: 100px;
  height: 100px;
  overflow: hidden;
  margin-right: 10px;
}

.recipe-card-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  display: block;
}

.recipe-card-content-list-item {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  height: 100%;
}

/* Верхняя строка - название рецепта, жирная, максимум 8 слов */
.recipe-card-content-list-item h4,
.recipe-card-content-list-item p.recipe-title {
  font-weight: 700 !important;
  margin: 0;
  font-size: 16px;
  line-height: 1.2em;
  word-wrap: break-word;
  overflow: hidden;
}

/* Нижняя строка - подзаголовок / книга, обычный шрифт, 5 слов с многоточием */
.recipe-card-content-list-item p.recipe-book {
  font-weight: 400;
  font-size: 14px;
  color: #555;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@media (max-width: 767px) {
  .related-recipes-grid {
    gap: 10px;
    margin: 0;
  }
  .recipe-card-list-item {
    flex-basis: 100%;
    margin: 0;
    flex-direction: row;
    height: 100px;
  }
  .recipe-card-image-wrapper {
    width: 100px;
    height: 100px;
    margin-right: 10px;
  }
  .recipe-card-content-list-item {
    justify-content: center;
  }
}

.recipe-card-list-item.hidden {
  display: none;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // Получаем/сохраняем оригинальный текст (чтоб не резать уже урезанные строки при повторном запуске)
  function getOriginal(el) {
    if (!el.dataset.original) el.dataset.original = el.textContent.trim();
    return el.dataset.original;
  }

  // Парсим высоту строки из computedStyle (fallback = fontSize * 1.2)
  function getLineHeight(el) {
    const cs = getComputedStyle(el);
    const lh = cs.lineHeight;
    if (lh && lh !== 'normal') return parseFloat(lh);
    const fs = parseFloat(cs.fontSize) || 16;
    return fs * 1.2;
  }

  // Основная функция: обрезать элемент по размеру контейнера
  // maxLines: сколько строк можно занимать (1 или 2)
  // paddingPx: запас до края (например 10px)
  function truncateByContainer(el, maxLines = 1, paddingPx = 10) {
    const original = getOriginal(el);
    if (!original) return;

    // Работаем со словами (не рвём слова посередине)
    let words = original.split(/\s+/);
    // Сначала поставим полный текст (чтоб корректно измерять)
    el.textContent = original;

    const lineH = getLineHeight(el);
    const maxH = Math.ceil(maxLines * lineH);

    // Проверка: помещается ли уже
    const fits = () => {
      if (maxLines > 1) {
        // проверяем высоту *и* ширину на случай неразрывных токенов
        return (el.scrollHeight <= maxH + paddingPx) && (el.scrollWidth <= el.clientWidth - paddingPx);
      } else {
        // для одной строки — проверяем ширину
        return el.scrollWidth <= el.clientWidth - paddingPx;
      }
    };

    if (fits()) return; // всё ок

    // Укорачиваем по словам (удаляем по одному слову с конца), пока не влезет
    let iter = 0;
    while (!fits() && words.length > 0 && ++iter < 200) {
      words.pop();
      el.textContent = words.join(' ') + (words.length ? '…' : '');
    }

    // Если даже после удаления всех слов что-то не влезает (редкий случай — длинное неразрывное слово),
    // делаем посимвольную подгонку (бинарный или простой перебор).
    if (!fits()) {
      const s = original;
      // Простой убывающий перебор символов (обычно короткие строки, перебор быстрый)
      for (let len = s.length; len > 0; len--) {
        el.textContent = s.slice(0, len) + '…';
        if (fits()) return;
      }
      // Если и так не влезло — оставим просто многоточие
      el.textContent = '…';
    }
  }

  // Применяем для верхних элементов (до 2 строк)
  document.querySelectorAll('.recipe-card-content-list-item p.recipe-title, .recipe-card-content-list-item h4')
    .forEach(el => {
      try {
        truncateByContainer(el, 2, 10); // 2 строки, запас 10px
      } catch (e) {
        // fallback: обрезаем простыми словами (8 слов)
        const orig = getOriginal(el);
        const words = orig.split(/\s+/).slice(0, 8);
        el.textContent = words.join(' ') + (orig.split(/\s+/).length > 8 ? '…' : '');
      }
    });

  // Применяем для нижних (1 строка). Если есть span.book-title, режем его, иначе режем весь <p>
  document.querySelectorAll('.recipe-card-content-list-item p.recipe-book').forEach(p => {
    try {
      const titleSpan = p.querySelector('.book-title');
      if (titleSpan) {
        // Режем именно содержимое названия (span), но учитываем ширину всего p (внутри fits() проверяет scrollWidth vs clientWidth)
        truncateByContainer(titleSpan, 1, 10);
        // Если после обрезки span всё ещё слишком широк из-за префикса — попробуем ещё раз, но уже уменьшая span сильнее:
        if (p.scrollWidth > p.clientWidth - 10) {
          // повторно укорачиваем titleSpan, на случай когда префикс занимает значимую ширину
          truncateByContainer(titleSpan, 1, 12);
        }
      } else {
        truncateByContainer(p, 1, 10);
      }
    } catch (e) {
      // fallback: старое поведение — по 5 слов
      const orig = getOriginal(p);
      const words = orig.split(/\s+/).slice(0, 5);
      p.textContent = words.join(' ') + (orig.split(/\s+/).length > 5 ? '…' : '');
    }
  });

}); // DOMContentLoaded
</script>


<script type="text/javascript" src="{{ site.baseurl }}/js/jquery.imgPin.min.js"></script>
<script>
	$(function() {
		$('.post img').imgPin();

		$('a[href*=\\#]').on('click', function(event){
			var el = $(this.hash);
			if (el.length > 0) {
				event.preventDefault();
				$('html,body').animate({scrollTop:$(this.hash).offset().top - 50}, 500);
			}
		});
	});
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const items = [...document.querySelectorAll("#related-list .recipe-card-list-item")];
    const btn = document.getElementById("show-more");
    let visible = 0;
    const firstStep = 4;
    const nextStep = 20;

    function showNext() {
      const step = (visible === 0) ? firstStep : nextStep;
      for (let i = visible; i < visible + step && i < items.length; i++) {
        items[i].classList.remove("hidden");
      }
      visible += step;
      if (visible >= items.length) {
        btn.style.display = "none";
      }
    }

    showNext();
    if(btn) btn.addEventListener("click", showNext);
  });
</script>
